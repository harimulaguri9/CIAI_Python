import os
import pytest
from pytest_html import extras
from playwright.async_api import async_playwright
from ciathena.pages.BasePage import BasePage
from ciathena.pages.LoginPage import LoginPage
from ciathena.pages.WelcomePage import WelcomePage
from ciathena.pages.InsightsHubPage import InsightsHubPage

pytest_plugins = ["pytest_asyncio"]

@pytest.fixture(scope="session")
async def browser_context():
    """Launch browser once per test session."""
    headless = os.getenv("HEADLESS", "true").lower() == "true"
    playwright = await async_playwright().start()
    browser = await playwright.chromium.launch(headless=headless, slow_mo=50)
    context = await browser.new_context()
    yield context
    await context.close()
    await browser.close()
    await playwright.stop()

@pytest.fixture(scope="function")
async def setup(browser_context, step_logger):
    """Setup before each test — opens page, logs in, returns page objects."""
    page = await browser_context.new_page()
    basepage = BasePage(page, step_logger)
    loginPage = LoginPage(page, step_logger)
    welcomePage = WelcomePage(page, step_logger)
    insightshubPage = InsightsHubPage(page, step_logger)

    await basepage.navigate("https://ciathena-qa.customerinsights.ai/")
    await loginPage.login()
    return insightshubPage
   # await page.close()

@pytest.hookimpl(tryfirst=True, hookwrapper=True)
def pytest_runtest_makereport(item, call):
    """Attach step logs to pytest HTML report."""
    outcome = yield
    rep = outcome.get_result()
    if hasattr(item, "step_logs") and rep.when == "call":
        html_steps = "<br>".join(item.step_logs)
        extra = getattr(rep, "extra", [])
        extra.append(extras.html(f"<div><strong>Execution Steps:</strong><br>{html_steps}</div>"))
        rep.extra = extra

@pytest.fixture
def step_logger(request):
    """Fixture to record step-by-step logs."""
    request.node.step_logs = []
    def log_step(message: str):
        print(f"[STEP] {message}")
        request.node.step_logs.append(f"➡️ {message}")
    return log_step
